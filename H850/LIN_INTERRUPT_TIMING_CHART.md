# H850 LINライブラリ 割り込みタイミングチャート

## 目次
1. [受信フレーム割り込みタイミングチャート](#受信フレーム割り込みタイミングチャート)
2. [送信フレーム割り込みタイミングチャート](#送信フレーム割り込みタイミングチャート)
3. [タイマ割り込みタイミングチャート](#タイマ割り込みタイミングチャート)
4. [Wake-up信号検出タイミングチャート](#wake-up信号検出タイミングチャート)
5. [タイミングパラメータ一覧](#タイミングパラメータ一覧)

---

## 受信フレーム割り込みタイミングチャート

### 1. 正常受信時（ID28h、4バイトデータの例）

```
時間軸 [ms]
0         1.0       2.0       3.0       4.0       5.0       6.0       7.0
|---------|---------|---------|---------|---------|---------|---------|---------|

LINバス信号:
         ___                  _________________________________________
  IDLE  |   |Synch|Synch|ID  |D0  |D1  |D2  |D3  |CS  |
  (Rec) |___|Break|Field|    |    |    |    |    |    |________________
        0.0 0.2  0.7 1.2 1.7 2.7  3.7  4.7  5.7  6.7   7.2


UART受信割り込み (SCI3_RX):
        ____    __    __    __    __    __    __    __    __
  Low   |  |    |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
  _____|  |____|  |__|  |__|  |__|  |__|  |__|  |__|  |__|  |__________
  High  ↑       ↑     ↑     ↑     ↑     ↑     ↑     ↑     ↑
       Break  Synch  ID   Data0  Data1 Data2 Data3  CS   (完了)
       0.2    0.7   1.2   1.7    2.7   3.7   4.7   5.7   6.7
        |      |     |     |      |     |     |     |     |
        v      v     v     v      v     v     v     v     v
      [割込1] [割込2][割込3][割込4][割込5][割込6][割込7][割込8][割込9]


タイマ割り込み (TMR_Z0): 49μs周期で連続発生
        _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _
  Low   | || || || || || || || || || || || || || || || || || || |
  _____|_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_|____
  High  ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
       (49μs毎に発生、ヘッダタイムアウト監視・レスポンスタイムアウト監視)


外部割り込み (IRQ0):

  Low
  ________________________________________________________________
  High  (通常動作時はトリガーなし)


同期フラグ (F1g_lin_rxframe_id28h):
                                                            ___________
  Low   ______________________________________________________|
  __________________________________________________________|  SET    |
  High                                                      ↑ 6.7ms
                                                          (受信完了)


処理フロー:

[割込1] 0.2ms: Synch Break検出
  - u1a_lin_data = 0x00
  - u1a_lin_err = Framing Error
  - u1l_lin_slv_sts = SYNCHFIELD_WAIT
  - タイマ起動（ヘッダタイムアウト監視開始）

[割込2] 0.7ms: Synch Field検出
  - u1a_lin_data = 0x55
  - u1l_lin_slv_sts = IDENTFIELD_WAIT
  - ビットタイミング調整

[割込3] 1.2ms: Identifier Field受信
  - u1a_lin_data = 0xA8 (Protected ID: 0x28 + Parity)
  - IDパリティチェック
  - スロット検索 → slot = 0 (ID28h)
  - 受信フレーム判定
  - u1l_lin_slv_sts = RCVDATA_WAIT
  - u1l_lin_rs_cnt = 0

[割込4] 1.7ms: Data0受信
  - u1a_lin_data = Data0
  - u1l_lin_rs_tmp[0] = Data0
  - u2l_lin_chksum += Data0
  - u1l_lin_rs_cnt = 1

[割込5] 2.7ms: Data1受信
  - u1a_lin_data = Data1
  - u1l_lin_rs_tmp[1] = Data1
  - u2l_lin_chksum += Data1
  - u1l_lin_rs_cnt = 2

[割込6] 3.7ms: Data2受信
  - u1a_lin_data = Data2
  - u1l_lin_rs_tmp[2] = Data2
  - u2l_lin_chksum += Data2
  - u1l_lin_rs_cnt = 3

[割込7] 4.7ms: Data3受信
  - u1a_lin_data = Data3
  - u1l_lin_rs_tmp[3] = Data3
  - u2l_lin_chksum += Data3
  - u1l_lin_rs_cnt = 4

[割込8] 5.7ms: Checksum受信
  - u1a_lin_data = Checksum
  - 計算チェックサム = ~u2l_lin_chksum
  - チェックサム比較
  - OK → フレームバッファへコピー
  - F1g_lin_rxframe_id28h = SET
  - F4g_lin_errframe_id28h = 0x00
  - u1l_lin_slv_sts = BREAK_UART_WAIT

[割込9] 6.7ms: (次フレームのSynch Break待ち)
```

### 2. エラー発生時の割り込みタイミング

#### 2-1. チェックサムエラー

```
時間軸 [ms]
0         1.0       2.0       3.0       4.0       5.0       6.0
|---------|---------|---------|---------|---------|---------|

UART受信割り込み (SCI3_RX):
        ____    __    __    __    __    __    __    __
  Low   |  |    |  |  |  |  |  |  |  |  |  |  |  |  |  |
  _____|  |____|  |__|  |__|  |__|  |__|  |__|  |__|  |_____________
  High  ↑       ↑     ↑     ↑     ↑     ↑     ↑     ↑
       Break  Synch  ID   Data0  Data1 Data2 Data3  CS(NG)
       0.2    0.7   1.2   1.7    2.7   3.7   4.7   5.7
                                                      |
                                                      v
                                              [チェックサムエラー]
                                              F4g_lin_errframe_id28h = 0x08
                                              F1g_lin_rxframe_id28h = SET
                                              u1l_lin_slv_sts = BREAK_UART_WAIT
```

#### 2-2. ヘッダタイムアウトエラー

```
時間軸 [ms]
0         1.0       2.0       3.0
|---------|---------|---------|

UART受信割り込み (SCI3_RX):
        ____
  Low   |  |
  _____|  |________________________________________________
  High  ↑
       Break
       0.2
        |
        v
      [Synch Break検出]
      タイマ起動


タイマ割り込み (TMR_Z0): 49μs周期
        _  _  _  _  _  _  ... (49カウント) ...  _
  Low   | || || || || || |                      |
  _____|_||_||_||_||_||_||_ ... ________________|_________
  High                          ↑
                              2.4ms (49 × 49μs)
                                |
                                v
                        [ヘッダタイムアウト]
                        F1g_lin_header_err_timeout_ch1 = SET
                        u1l_lin_slv_sts = BREAK_UART_WAIT


同期フラグ:
        (Synch Fieldが来ないためエラー)
```

---

## 送信フレーム割り込みタイミングチャート

### 1. 正常送信時（ID23h、4バイトデータの例）

```
時間軸 [ms]
0         1.0       2.0       3.0       4.0       5.0       6.0       7.0
|---------|---------|---------|---------|---------|---------|---------|---------|

LINバス信号:
         ___                  _________________________________________
  IDLE  |   |Synch|Synch|ID  |D0  |D1  |D2  |D3  |CS  |
  (Rec) |___|Break|Field|    |    |    |    |    |    |________________
        0.0 0.2  0.7 1.2 1.7 2.7  3.7  4.7  5.7  6.7   7.2
                          |<--- マスタ送信 --->|<--- スレーブ送信 --->|


UART受信割り込み (SCI3_RX): ヘッダ受信 + 送信データリードバック
        ____    __    __    __    __    __    __    __    __
  Low   |  |    |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
  _____|  |____|  |__|  |__|  |__|  |__|  |__|  |__|  |__|  |__________
  High  ↑       ↑     ↑     ↑     ↑     ↑     ↑     ↑     ↑
       Break  Synch  ID   Data0  Data1 Data2 Data3  CS   (完了)
       0.2    0.7   1.2   1.7    2.7   3.7   4.7   5.7   6.7
        |      |     |     |      |     |     |     |     |
        v      v     v     v      v     v     v     v     v
      [割込1] [割込2][割込3][割込4][割込5][割込6][割込7][割込8][割込9]
                          |<-受信->|<------- 送信リードバック ------->|


UART送信処理 (TDR書き込み):
                          ____  ____  ____  ____  ____
  Low                     |  |  |  |  |  |  |  |  |  |
  ________________________|  |__|  |__|  |__|  |__|  |______________
  High                    ↑     ↑     ↑     ↑     ↑
                        Data0 Data1 Data2 Data3  CS
                        1.7   2.7   3.7   4.7   5.7
                         |     |     |     |     |
                         v     v     v     v     v
                    [TDR書込][TDR書込][TDR書込][TDR書込][TDR書込]


タイマ割り込み (TMR_Z0): 49μs周期で連続発生
        _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _
  Low   | || || || || || || || || || || || || || || || || || || |
  _____|_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_||_|____
  High  (49μs毎に発生、レスポンスタイムアウト監視)


同期フラグ (F1g_lin_txframe_id23h):
                                                            ___________
  Low   ______________________________________________________|
  __________________________________________________________|  SET    |
  High                                                      ↑ 6.7ms
                                                          (送信完了)


処理フロー:

[割込1] 0.2ms: Synch Break検出
  - u1a_lin_data = 0x00
  - u1a_lin_err = Framing Error
  - u1l_lin_slv_sts = SYNCHFIELD_WAIT

[割込2] 0.7ms: Synch Field検出
  - u1a_lin_data = 0x55
  - u1l_lin_slv_sts = IDENTFIELD_WAIT

[割込3] 1.2ms: Identifier Field受信
  - u1a_lin_data = 0x63 (Protected ID: 0x23 + Parity)
  - スロット検索 → slot = 5 (ID23h)
  - 送信フレーム判定
  - u1l_lin_slv_sts = SNDDATA_WAIT
  - u1l_lin_rs_cnt = 0

[割込4] 1.7ms: Data0送信開始
  - TDR = xng_lin_frm_buf[5].xng_lin_data.u1g_lin_byte[0]
  - 送信完了後、UART受信割り込み発生（リードバック）
  - リードバック確認: u1a_lin_data == 送信データ？
  - OK → u1l_lin_rs_cnt = 1

[割込5] 2.7ms: Data1送信
  - TDR = xng_lin_frm_buf[5].xng_lin_data.u1g_lin_byte[1]
  - リードバック確認
  - OK → u1l_lin_rs_cnt = 2

[割込6] 3.7ms: Data2送信
  - TDR = xng_lin_frm_buf[5].xng_lin_data.u1g_lin_byte[2]
  - リードバック確認
  - OK → u1l_lin_rs_cnt = 3

[割込7] 4.7ms: Data3送信
  - TDR = xng_lin_frm_buf[5].xng_lin_data.u1g_lin_byte[3]
  - リードバック確認
  - OK → u1l_lin_rs_cnt = 4

[割込8] 5.7ms: Checksum送信
  - TDR = xng_lin_frm_buf[5].un_state.st_bit.u2g_lin_chksum
  - リードバック確認
  - OK → F1g_lin_txframe_id23h = SET
  - F4g_lin_errframe_id23h = 0x00
  - u1l_lin_slv_sts = BREAK_UART_WAIT

[割込9] 6.7ms: (送信完了、次フレーム待ち)
```

### 2. ビットエラー発生時

```
時間軸 [ms]
0         1.0       2.0       3.0
|---------|---------|---------|

UART送信処理:
                          ____
  Low                     |  |
  ________________________|  |_____________________________
  High                    ↑
                        Data0
                        1.7
                         |
                         v
                    [TDR書込: 0x55]


UART受信割り込み (リードバック):
                          ____
  Low                     |  |
  ________________________|  |_____________________________
  High                    ↑
                        1.7
                         |
                         v
                    [リードバック: 0x54 (NG!)]
                    送信データ ≠ リードバックデータ
                         |
                         v
                    [ビットエラー]
                    F4g_lin_errframe_id23h = 0x04
                    F1g_lin_txframe_id23h = SET
                    u1l_lin_slv_sts = BREAK_UART_WAIT
```

---

## タイマ割り込みタイミングチャート

### 1. 通常動作時（ヘッダタイムアウト監視）

```
時間軸 [ms]
0         0.5       1.0       1.5       2.0       2.5
|---------|---------|---------|---------|---------|

タイマ割り込み (TMR_Z0): 49μs周期
  _  _  _  _  _  _  _  _  _  _  _  _  _  _ ... (49カウント)
  | || || || || || || || || || || || || || |
__|_||_||_||_||_||_||_||_||_||_||_||_||_||_||________________
  ↑                                        ↑
 cnt=0                                   cnt=49
 0.0ms                                   2.4ms


カウンタ (u1l_lin_frm_tm_cnt):
  0 → 1 → 2 → 3 → ... → 48 → 49
  |                             |
  v                             v
[タイマ起動]              [タイムアウト判定]
                          if (cnt >= 49) {
                            ヘッダタイムアウトエラー
                          }


UART受信割り込み (正常時):
        ____    __    __
  Low   |  |    |  |  |  |
  _____|  |____|  |__|  |___________________________________
  High  ↑       ↑     ↑
       Break  Synch  ID
       0.2    0.7   1.2
        |      |     |
        v      v     v
    [タイマ起動][継続][ID受信]
                          |
                          v
                    [タイマ停止 or リセット]
                    cnt < 49なので正常
```

### 2. Physical Busエラー検出（25000bitタイム無通信）

```
時間軸 [秒] @ 9600bps
0         0.5       1.0       1.5       2.0       2.5       3.0
|---------|---------|---------|---------|---------|---------|

LINバス信号:
  __________________________________________________________ (IDLE継続)
  High


タイマ割り込み (TMR_Z0): 49μs周期で連続発生
  (継続的にカウント: u2l_lin_bus_tm_cnt++)


Physical Busエラーカウンタ (u2l_lin_bus_tm_cnt):
  0 → 1 → 2 → ... → 509 → 510
  |                         |
  v                         v
[カウント開始]          [Physical Busエラー]
                        (25000bitタイム ≈ 2.6秒 @ 9600bps)
                        F1g_lin_p_bus_err_ch1 = SET


処理フロー:
  49μs × 510 = 24.99ms × 約104回 ≈ 2600ms (2.6秒)
  25000bit ÷ 9600bps = 2.604秒


エラー検出後:
                                                            ___________
  Low   ______________________________________________________|
  __________________________________________________________|  SET    |
  High                                                      ↑ 2.6秒
                                              [Physical Busエラー検出]
                                              F1g_lin_p_bus_err_ch1 = SET
                                              ネットワーク管理へ通知
```

---

## Wake-up信号検出タイミングチャート

### 1. スリープ状態からWake-up信号検出

```
時間軸 [ms]
0         50        100       150       200       250       300
|---------|---------|---------|---------|---------|---------|

LINバス信号 (Wake-up信号):
  _____      ___________________________________________________
       |    |     (250μs〜5ms のドミナントパルス)
  _____|____|
  High ↑    ↑
      0ms 0.25ms (立ち下がりエッジ)


外部割り込み (IRQ0): 立ち下がりエッジ検出
        ____
  Low   |  |
  _____|  |_______________________________________________________
  High  ↑
       0.25ms
        |
        v
    [Wake-up信号検出]
    l_vog_lin_irq_int()
    u1l_lin_slv_sts = BREAK_UART_WAIT
    外部割り込み禁止
    UART受信許可


スレーブ状態遷移:
  _______________________________________________________________
  SLEEP         ↑                    WAKE_WAIT
  ______________|________________________________________________
               0.25ms
              [IRQ0割り込み]


Wake-up信号送信シーケンス (50ms間隔、最大2回):
  _____      ___      ___      _________
       |    |   |    |   |    |
  _____|____|___|____|___|____|_________________________________
  High ↑         ↑         ↑
      0ms       50ms     100ms
       |         |         |
       v         v         v
   [1回目]   [2回目]  [マスタ応答確認]


UART受信割り込み (マスタからのフレーム受信):
                            ____
  Low                       |  |
  __________________________|  |_____________________________
  High                      ↑
                          150ms (マスタ応答)
                           |
                           v
                      [Wake-up成功]
                      u1l_lin_slv_stat = U1G_LIN_SLVSTAT_ACTIVE
```

### 2. Wake-upリトライ失敗（マスタ異常検出）

```
時間軸 [秒]
0         1.0       2.0       3.0       4.0       5.0
|---------|---------|---------|---------|---------|

Wake-up信号送信:
  _____      ___      _________________________________________
       |    |   |    |
  _____|____|___|____|_________________________________________
       ↑         ↑
      0ms       50ms (2回リトライ完了)


タイマカウント (NM Tick処理):
  0 → 6ms → 12ms → ... → 1500ms
  |                       |
  v                       v
[リトライ開始]      [3 Breaks Timeout]
                    u2l_lin_nm_3brks_cnt >= 1500ms
                         |
                         v
                    [マスタ異常カウント++]
                    u1l_lin_nm_msterr_cnt++


マスタ異常検出 (3回失敗):
  試行1  試行2  試行3
   NG     NG     NG
   |      |      |
   v      v      v
  1.5s   3.0s   4.5s
              ↑
              [マスタ異常検出]
              u1l_lin_nm_msterr = SET
              u1l_lin_slv_stat = U1G_LIN_SLVSTAT_SLEEP


外部割り込み (IRQ0):
  (マスタからの応答なし)
  _______________________________________________________________
  High (割り込み発生なし)
```

---

## タイミングパラメータ一覧

### 1. LIN通信タイミング (@9600bps)

| パラメータ | 記号 | 値 | 説明 |
|----------|------|-----|------|
| 1ビット時間 | tbit | 104.2μs | 1 / 9600bps |
| 1バイト時間 | tbyte | 1.042ms | 10bit (Start + 8Data + Stop) × tbit |
| Synch Break長 | tbreak | 650μs〜 | 最小13bitタイム (LIN仕様) |
| Synch Field | tsync | 1.042ms | 0x55 = 1バイト |
| ヘッダ最大時間 | theader_max | 2.4ms | 49カウント × 49μs |
| レスポンス最大時間 | tresp_max | 可変 | データ長に依存 (約1.4 × データ長 ms) |

### 2. 割り込み周期

| 割り込み種別 | 周期/条件 | 優先度 | 処理時間目安 |
|------------|----------|--------|------------|
| UART受信割り込み (SCI3_RX) | 1バイト受信毎 | 高 | < 100μs |
| タイマ割り込み (TMR_Z0) | 49μs固定 | 中 | < 20μs |
| 外部割り込み (IRQ0) | エッジ検出時 | 低 | < 50μs |

### 3. エラー検出タイミング

| エラー種別 | 検出タイミング | タイムアウト値 |
|----------|--------------|--------------|
| ヘッダタイムアウト | Synch Break後 | 2.4ms (49 × 49μs) |
| レスポンスタイムアウト | ID受信後 | データ長依存 |
| Physical Busエラー | 無通信継続 | 2.6秒 (25000bitタイム @ 9600bps) |
| チェックサムエラー | Checksum受信時 | - |
| UARTエラー | データ受信時 | - |

### 4. ネットワーク管理タイミング

| パラメータ | 値 | 説明 |
|----------|-----|------|
| Wake-up送信許可時間 | 550ms | PON状態からWAKE_WAIT状態への遷移時間 |
| Wake-upリトライ間隔 | 50ms | Wake-up信号の再送間隔 |
| Wake-upリトライ回数 | 2回 | 最大リトライ回数 |
| 3 Breaks Timeout | 1500ms | 3回のWake-up失敗判定時間 |
| マスタ異常判定回数 | 3回 | Wake-up失敗の累積回数 |
| Bus Idle Timeout | 2.6秒 (9600bps) | 25000bitタイム無通信でスリープ移行 |
| NM Tick周期 | 6ms | ネットワーク管理のタイムベース |

### 5. フレームタイミング例 (4バイトデータフレーム)

```
合計フレーム時間 ≈ 7.2ms (@9600bps)

内訳:
  Synch Break    : 0.65ms  (13bitタイム)
  Break Delimiter: 0.10ms  (1bitタイム)
  Synch Field    : 1.04ms  (10bitタイム)
  ID Field       : 1.04ms  (10bitタイム)
  Data0          : 1.04ms  (10bitタイム)
  Data1          : 1.04ms  (10bitタイム)
  Data2          : 1.04ms  (10bitタイム)
  Data3          : 1.04ms  (10bitタイム)
  Checksum       : 1.04ms  (10bitタイム)
  Inter-frame    : 0.10ms  (最小1bitタイム)
  ━━━━━━━━━━━━━━━━━━━━━━━
  合計           : 約7.19ms
```

---

## 補足: 割り込みネスティング

### 割り込み優先順位と割り込み禁止制御

```
時間軸 [μs]
0         100       200       300       400       500
|---------|---------|---------|---------|---------|

UART受信割り込み:
  ____                                    ____
  |  |                                    |  |
__|  |____________________________________|  |___________
  ↑                                        ↑
  [割込開始]                            [次の割込]
  |
  v
l_ifc_rx_ch1()
  |
  ├─ 割り込み禁止 (CCR.I = 1)
  │   u1l_lin_flg = l_u1g_lin_irq_dis()
  │
  ├─ クリティカルセクション処理
  │   (フラグ操作、バッファアクセス)
  │
  └─ 割り込み許可復元 (CCR.I復元)
      l_vog_lin_irq_res(u1l_lin_flg)


タイマ割り込み (優先度:中): UART割り込み処理中は待機
              ____
  Low         |  | (UART処理中は保留)
  ____________|  |______________________________________
  High        ↑
            150μs (UART処理完了後に実行)


外部割り込み (優先度:低): 上位割り込み処理中は待機
  _______________________________________________________________
  High (割り込み発生なし、またはマスク中)
```

### ネスト割り込み例

```
[シナリオ: UART受信中にタイマ割り込み発生]

CPU実行状態:
  ┌────────┐  ┌──────┐  ┌────────┐
  │メイン  │  │UART  │  │タイマ  │  │メイン  │
  │処理    │  │割込  │  │割込    │  │処理    │
  └────────┘  └──────┘  └────────┘  └────────┘
  ↑           ↑        ↑          ↑
  0μs       100μs    120μs      200μs


割り込みフラグ:
  UART: ____|‾‾‾‾‾‾‾‾‾|_______________________________
  TMR:  ____________|‾‾‾‾‾‾|_________________________


処理フロー:
  100μs: UART受信割り込み発生
         → l_ifc_rx_ch1() 実行開始

  120μs: タイマ割り込み発生
         → UART処理中のため保留

  180μs: UART処理完了
         → 保留中のタイマ割り込み実行
         → l_ifc_tm_ch1() 実行

  200μs: タイマ処理完了
         → メイン処理へ復帰
```

---

**Document Version**: 1.0
**Last Updated**: 2025-01-22
**Author**: LIN Timing Analysis Tool
